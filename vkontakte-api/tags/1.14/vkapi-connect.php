<?php 		function doHttpRequest( $urlreq )	{		$ch = curl_init(); // start		curl_setopt( $ch, CURLOPT_URL, "$urlreq" ); // where		curl_setopt ( $ch, CURLOPT_RETURNTRANSFER, TRUE ); // why		$request_result = curl_exec( $ch ); // do this		curl_close( $ch ); // close, free memory		return $request_result; // profit	}		function params($params) {		$pice = array();		foreach($params as $k=>$v) {			$pice[] = $k.'='.urlencode($v);		}		return implode('&',$pice);	}		function get_VkMethod ( $method_name, $parameters = array(), $access_token ) {		ksort( $parameters );		$parameters = $this->params( $parameters );		$urlreq = VKAPI_M . $method_name . "?" . $parameters . "&access_token=" . $access_token;		$result = doHttpRequest( $urlreq );		$data = json_decode ( $result );		return $data["response"];	}	define ( 'VKAPI_AT', 'https://api.vkontakte.ru/oauth/access_token') ;define ( 'VKAPI_M', 'https://api.vkontakte.ru/method/' );		if ( isset( $_GET['code'] ) ) {		require_once ( '../../wp-includes/pluggable.php' );		global $wpdb;		$post_id = $_GET['id'];		$get_id = $wpdb->get_var( $wpdb->prepare( 			"				SELECT `ID` 				FROM $wpdb->users				WHERE `vkapi_uid` = %s			", 			$post_id			) );		//	};			if ( isset( $_GET['code'] ) ) {		$code = $_GET['code'];		$app_secret = get_option( 'vkapi_api_secret' );		$app_id = get_option( 'vkapi_appid' );		$urlreq = VKAPI_AT . '?client_id=' . $app_id . '&client_secret=' . $app_secret . '&code=' . $code;		$result = doHttpRequest( $urlreq );		$data = json_decode ( $result );		$vkapi_wp_id = get_current_user_id();		if ( is_user_logged_in() ) {			add_user_meta( $vkapi_wp_id, 'vkapi_at', $data['access_token'], FALSE );			add_user_meta( $vkapi_wp_id, 'vkapi_uid', $data['user_id'], TRUE );			$vkapi_user = get_VkMethod( 'getProfiles', array( 'uids' => $data['user_id'], 'fields' => 'uid,first_name,nickname,last_name,screen_name,photo_medium_rec' ), $data['access_token'] );			add_user_meta( $vkapi_wp_id, 'vkapi_ava', $vkapi_user['photo_medium_rec'], FALSE );		}		else { 			$vkapi_user = get_VkMethod( 'getProfiles', array( 'uids' => $data['user_id'], 'fields' => 'uid,first_name,nickname,last_name,screen_name,photo_medium_rec' ), $data['access_token'] );			$user_pass = wp_generate_password();			$user_login = $vkapi_user['screen_name'];			$user_email = $user_login . '@vk.com';			$nickname = $vkapi_user['nickname'];			$first_name = $vkapi_user['first_name'];			$last_name = $vkapi_user['last_name'];			$rich_editing = TRUE;			$role = 'Subscriber';			$jabber = $user_login . '@vk.com';			$display_name = "$first_name $last_name";				$userdata = array (					user_pass => $user_pass,					user_login => $user_login,					user_email => $user_email,					nickname => $nickname,					first_name => $first_name,					last_name => $last_name,					rich_editing => $rich_editing,					role => $role,					jabber => $jabber,					display_name => $display_name				);			$user_id = wp_insert_user( $userdata );			if ( is_wp_error($user_id) ) {				echo $user->get_error_message();				exit;			};			add_user_meta( $user_id, 'vkapi_at', $data['access_token'], FALSE );			add_user_meta( $user_id, 'vkapi_uid', $data['user_id'], TRUE );			add_user_meta( $user_id, 'vkapi_ava', $vkapi_user['photo_medium_rec'], FALSE );			if( $user_id ) {				$creds = array();				$creds['user_login'] = $user_login;				$creds['user_password'] = $user_pass;				$creds['remember'] = TRUE;				$user = wp_signon( $creds );				if ( is_wp_error($user) ) echo $user->get_error_message();			};		};	};?>